function doGet(e) {
  try {
    // 1. 獲取JSONP回調函數名和表單數據
    const callback = e.parameter.callback;
    const dataStr = e.parameter.data;
    if (!callback || !dataStr) {
      return ContentService.createTextOutput(`${callback}({"status":"error","message":"缺少參數"})`)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    // 2. 解析表單數據
    const formData = JSON.parse(dataStr);
    
    // 3. 獲取當前表格，創建新工作表（如果不存在）
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('健康評估數據');
    if (!sheet) {
      sheet = ss.insertSheet('健康評估數據');
      // 創建表頭
      sheet.appendRow([
        '提交時間', '姓名', '年齡', '性別', '電話', '身高', '體重', 'BMI',
        '腰圍', '血壓', '血糖', '職業', '症狀列表', '症狀數量',
        '習慣列表', '習慣數量', '主要問題', '症狀持續時間',
        '可能原因', '過敏史', '既往病史'
      ]);
    }
    
    // 4. 插入數據行
    sheet.appendRow([
      formData.submitTime,
      formData.basicInfo.name,
      formData.basicInfo.age,
      formData.basicInfo.gender,
      formData.basicInfo.phone,
      formData.basicInfo.height,
      formData.basicInfo.weight,
      formData.basicInfo.bmi,
      formData.basicInfo.waist,
      formData.basicInfo.bloodPressure,
      formData.basicInfo.bloodSugar,
      formData.basicInfo.occupation,
      formData.symptoms,
      formData.symptomCount,
      formData.habits,
      formData.habitCount,
      formData.healthIssues.mainConcern,
      formData.healthIssues.symptomDuration,
      formData.healthIssues.possibleCauses,
      formData.healthIssues.allergyHistory,
      formData.healthIssues.medicalHistory
    ]);
    
    // 5. 返回JSONP成功響應
    return ContentService.createTextOutput(`${callback}({"status":"success","message":"提交成功"})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
      
  } catch (error) {
    // 6. 返回錯誤響應
    const callback = e.parameter.callback || 'jsonpError';
    return ContentService.createTextOutput(`${callback}({"status":"error","message":"${error.message}"})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}
