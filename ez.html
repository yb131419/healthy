<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§¬ å½¥å½¬ è‡ªæª¢è¡¨ç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { 
            primary: '#00B900', 
            secondary: '#E8F4EA',
            lightBg: '#f8faf9',
            accent: '#008000',
            neutral: '#f3f4f6'
          },
          fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
        }
      }
    };
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .fade-in { animation: fadeIn 0.45s ease-in-out; }
      .slide-down { animation: slideDown 0.5s ease-out; }
      .scale-in { animation: scaleIn 0.3s ease-out; }
      .symptom-card-hover { transition: all 0.2s ease; }
      .symptom-card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .factor-tag { font-size: 0.75rem; padding: 0.15rem 0.35rem; border-radius: 4px; }
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    @keyframes scaleIn { from { transform: scale(0.98); opacity: 0 } to { transform: scale(1); opacity: 1 } }
  </style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-4">
  <div class="max-w-4xl w-full bg-white rounded-xl shadow-md overflow-hidden fade-in self-center">
    <div class="bg-primary p-6 text-white text-center">
      <i class="fa fa-heartbeat text-4xl mb-3"></i>
      <h1 class="text-2xl font-bold">ğŸ§¬ å½¥å½¬ è‡ªæª¢è¡¨ç³»çµ±</h1>
    </div>

    <div class="p-6">
      <div id="status" class="flex items-center justify-center py-6 text-gray-700 text-center">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-3"></div>
          <p id="status-text">æ­£åœ¨åˆå§‹åŒ– LIFF...</p>
        </div>
      </div>

      <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4"></div>

      <div id="result-card" class="hidden bg-secondary/50 border border-primary/20 rounded-lg p-5 mb-6 text-center slide-down">
        <div id="result-main" class="text-lg font-medium mb-2"></div>
        <div id="result-details" class="text-sm text-gray-700 mb-3"></div>
      </div>

      <!-- è‡ªæª¢è¡¨å€åŸŸ - é è¨­éš±è—ï¼Œé©—è­‰é€šéå¾Œè‡ªå‹•é¡¯ç¤º -->
      <div id="checklist-section" class="hidden scale-in">
        <!-- è‡ªæª¢è¡¨æ¨™é¡Œå€åŸŸ -->
        <div class="mb-6 text-center">
          <h2 class="text-2xl font-bold text-primary mb-2">è‡ªæª¢è¡¨å¡«å¯«å€åŸŸ</h2>
          <p class="text-gray-600">è«‹æ ¹æ“šè‡ªèº«æƒ…æ³å‹¾é¸å°æ‡‰ç—‡ç‹€ï¼Œä¸¦å¡«å¯«ç—‡ç‹€ç›¸é—œè³‡è¨Š</p>
          <div class="mt-4 flex flex-wrap justify-center gap-2 text-sm text-gray-700">
            <span class="bg-blue-100 text-blue-800 factor-tag">æ°£è¡€ä¸è¶³</span>
            <span class="bg-green-100 text-green-800 factor-tag">å¾®å¾ªç’°ä¸é€š</span>
            <span class="bg-yellow-100 text-yellow-800 factor-tag">æ¯’ç´ </span>
            <span class="bg-orange-100 text-orange-800 factor-tag">è¡€è„‚ç²˜ç¨ </span>
            <span class="bg-purple-100 text-purple-800 factor-tag">å¯’æ¶¼æ¿•ç—‡</span>
            <span class="bg-pink-100 text-pink-800 factor-tag">å…ç–«</span>
            <span class="bg-indigo-100 text-indigo-800 factor-tag">æƒ…ç·’</span>
          </div>
        </div>

        <!-- ç—‡ç‹€éæ¿¾èˆ‡çµ±è¨ˆ -->
        <div class="bg-neutral rounded-lg p-4 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
          <div class="flex flex-wrap gap-2">
            <button id="select-all" class="bg-primary text-white px-4 py-2 rounded-md text-sm hover:bg-primary/90 transition">
              <i class="fa fa-check-square-o mr-1"></i>å…¨é¸
            </button>
            <button id="deselect-all" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm hover:bg-gray-300 transition">
              <i class="fa fa-square-o mr-1"></i>å–æ¶ˆå…¨é¸
            </button>
            <button id="filter-selected" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-600 transition">
              <i class="fa fa-filter mr-1"></i>åªçœ‹å·²é¸
            </button>
          </div>
          <div class="text-gray-700 text-sm">
            å·²å‹¾é¸: <span id="selected-count" class="font-bold text-primary">0</span>/100 å€‹ç—‡ç‹€
          </div>
        </div>

        <!-- ç—‡ç‹€æ¸…å–®å®¹å™¨ -->
        <div id="symptoms-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">
          <!-- JSå‹•æ…‹ç”Ÿæˆç—‡ç‹€å¡ç‰‡ -->
        </div>

        <!-- æäº¤æŒ‰éˆ• -->
        <div class="text-center mt-8 mb-4">
          <button id="submit-checklist" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
            <i class="fa fa-paper-plane mr-2"></i>æäº¤è‡ªæª¢è¡¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æäº¤æˆåŠŸæ¨¡æ…‹æ¡† -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden fade-in">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
        <i class="fa fa-check text-3xl text-primary"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">æäº¤æˆåŠŸï¼</h3>
      <p class="text-gray-600 mb-6">æ‚¨çš„è‡ªæª¢è¡¨å·²é †åˆ©æäº¤ï¼Œæ„Ÿè¬æ‚¨çš„å¡«å¯«</p>
      <button id="close-modal" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg transition">
        ç¢ºèª
      </button>
    </div>
  </div>

  <script>
    const LIFF_ID = "2008578880-NznKeG2a";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbykBtM2_PM7IZ-ZUU4tgTqVa1xGhVQFaZ523FXc4ivdLz_GZ09sdmL6s5zk7SdloFuG/exec";
    const JSONP_TIMEOUT = 15000;
    const PERMANENT_EXPIRY_DATE = "9999/12/31";

    // ä¸ƒå¤§å¥åº·è¦ç´ å°æ‡‰æ¨£å¼
    const factorStyles = {
      æ°”è¡€: { className: 'bg-blue-100 text-blue-800', label: 'æ°£è¡€ä¸è¶³' },
      å¾®å¾ªç¯: { className: 'bg-green-100 text-green-800', label: 'å¾®å¾ªç’°ä¸é€š' },
      æ¯’ç´ : { className: 'bg-yellow-100 text-yellow-800', label: 'æ¯’ç´ ' },
      è¡€è„‚: { className: 'bg-orange-100 text-orange-800', label: 'è¡€è„‚ç²˜ç¨ ' },
      å¯’å‡‰æ¹¿: { className: 'bg-purple-100 text-purple-800', label: 'å¯’æ¶¼æ¿•ç—‡' },
      å…ç–«: { className: 'bg-pink-100 text-pink-800', label: 'å…ç–«' },
      æƒ…ç»ª: { className: 'bg-indigo-100 text-indigo-800', label: 'æƒ…ç·’' }
    };

    // æ™‚é–“é•·çŸ­é¸é …
    const durationOptions = [
      { value: '', label: 'è«‹é¸æ“‡æ™‚é–“' },
      { value: '1w', label: '1å‘¨å…§' },
      { value: '1-3m', label: '1-3å€‹æœˆ' },
      { value: '3-6m', label: '3-6å€‹æœˆ' },
      { value: '6m+', label: '6å€‹æœˆä»¥ä¸Š' }
    ];

    // ç—‡ç‹€è¼•é‡é¸é …
    const severityOptions = [
      { value: '', label: 'è«‹é¸æ“‡è¼•é‡' },
      { value: 'mild', label: 'è¼•å¾®ï¼ˆä¸å½±éŸ¿ç”Ÿæ´»ï¼‰' },
      { value: 'moderate', label: 'ä¸­ç­‰ï¼ˆå¶çˆ¾å½±éŸ¿ï¼‰' },
      { value: 'severe', label: 'åš´é‡ï¼ˆç¶“å¸¸å½±éŸ¿ï¼‰' }
    ];

    // å®Œæ•´ç—‡ç‹€æ•¸æ“šï¼ˆåŒ…å«ä¸ƒå¤§è¦ç´ å°æ‡‰é—œä¿‚ï¼‰
    const fullSymptomData = [
      {seq: 1, symptom: "è¨˜æ†¶åŠ›ä¸‹é™", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 2, symptom: "æ€ç¶­æ–·é›»", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 3, symptom: "åæ‡‰é²éˆ", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 4, symptom: "å—œç¡", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 5, symptom: "å¤šå¤¢", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 6, symptom: "é ­æšˆ", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 7, symptom: "é ­ç–¼", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 8, symptom: "é ­éº»", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 9, symptom: "æšˆè»Š", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 10, symptom: "å¤±çœ ", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 11, symptom: "é ­é¢æ²¹è†©", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "â—‹", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 12, symptom: "è„«é«®", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 13, symptom: "é ­é«®ç¨€å°‘", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 14, symptom: "æ˜“æ‰“å“ˆæ¬ ", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 15, symptom: "å¸¸å˜†æ°£", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 16, symptom: "çœ¼ä¹¾æ¾€", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 17, symptom: "çœ¼ç™¢", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 18, symptom: "çœ¼ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 19, symptom: "è¦–åŠ›æ¨¡ç³Š", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 20, symptom: "çœ¼å±å¤š", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 21, symptom: "çœ¼æ€•å…‰æµæ·š", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 22, symptom: "éº¥ç²’è…«", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 23, symptom: "è½åŠ›ä¸‹é™", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 24, symptom: "è€³ç™¢", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 25, symptom: "è€³é³´", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 26, symptom: "è€³ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 27, symptom: "è€³å±å¤š", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 28, symptom: "è€³å…§æ½®æ¿•", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 29, symptom: "æ‰“é¼¾", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 30, symptom: "é¼»å¡", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 31, symptom: "æ„›æ‰“å™´åš", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 32, symptom: "å¸¸æµé»ƒæ¶•", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 33, symptom: "é¼»ç‚", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 34, symptom: "æ„Ÿå†’æ™‚é–“é•·", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 35, symptom: "å—“å­å¹²", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 36, symptom: "å–‰åš¨ç™¢", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 37, symptom: "å–‰åš¨ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: "â—‹"},
      {seq: 38, symptom: "å’³å—½", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 39, symptom: "ç—°å¤š", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 40, symptom: "å‘¼å¸å›°é›£", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 41, symptom: "å£è‹¦", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 42, symptom: "å£å¹²", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 43, symptom: "å£è‡­", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 44, symptom: "å£è…”æ½°ç˜", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 45, symptom: "èˆŒæ½°ç˜", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 46, symptom: "å˜´å”‡éº»", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 47, symptom: "èˆŒç¡¬", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 48, symptom: "èƒ¸æ‚¶æ°£çŸ­", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 49, symptom: "å¿ƒæ…Œå¿ƒæ‚¸", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 50, symptom: "å¿ƒçµç—›", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 51, symptom: "æŒ‡ç”²å‡¹é™·", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 52, symptom: "åŠæœˆç—•å°‘", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 53, symptom: "æ‰‹è…³è„«çš®", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 54, symptom: "æ‰‹è…³å‡ºæ±—", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 55, symptom: "æ‰‹è…³æ¶¼", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 56, symptom: "æ‰‹è…³ç†±", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 57, symptom: "æ‰‹è¶³éº»æœ¨", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 58, symptom: "å››è‚¢ä¹åŠ›", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 59, symptom: "éœè„ˆæ›²å¼µ", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "â—‹", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 60, symptom: "é—œç¯€ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 61, symptom: "è‚©é…¸ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 62, symptom: "é ¸æ¤ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 63, symptom: "è…°é…¸ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 64, symptom: "å°¿æ¸¾æ¿", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 65, symptom: "å°¿å¤šæ²«", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 66, symptom: "å°¿æœ‰æ€ªå‘³", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 67, symptom: "å¤œå°¿å¤š", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 68, symptom: "ä¾¿ç§˜", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 69, symptom: "å¤§ä¾¿ä¸æˆå½¢", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 70, symptom: "ä¾¿æºä¸æ·¨", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 71, symptom: "é«˜è¡€è„‚", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "â—‹", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 72, symptom: "é«˜è¡€å£“", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 73, symptom: "é«˜è¡€ç³–", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 74, symptom: "ä½è¡€ç³–", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 75, symptom: "ä½è¡€å£“", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 76, symptom: "ç¶“æœŸé ­ç—›", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 77, symptom: "æœˆç¶“é‡å°‘", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 78, symptom: "ç¶“æœŸæ™‚é•·", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 79, symptom: "ç¶“æœŸæ¨å", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 80, symptom: "æœˆç¶“æœ‰è¡€å¡Š", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 81, symptom: "ä¹³è…ºå¢ç”Ÿ", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 82, symptom: "ç¶“æœŸè…°ç—›", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 83, symptom: "ç¶“æœŸæå‰", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 84, symptom: "æœˆç¶“é‡å¤š", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: "â—‹"},
      {seq: 85, symptom: "ä¸æ„›èªªè©±", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 86, symptom: "æƒ¡å¿ƒ", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 87, symptom: "èƒƒè„¹", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 88, symptom: "èƒƒé…¸", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 89, symptom: "èƒƒç—›", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 90, symptom: "æ¶ˆåŒ–ä¸è‰¯", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 91, symptom: "è‚¥èƒ–", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "â—‹", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 92, symptom: "çš®è†šç™¢", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 93, symptom: "æ¿•ç–¹", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "â—‹", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 94, symptom: "å„ç¨®éæ•", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 95, symptom: "ç—¤ç˜¡", æ°”è¡€: "", å¾®å¾ªç¯: "â—‹", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 96, symptom: "è„‚è‚ªç˜¤", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "â—‹", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 97, symptom: "èº«é«”ç•°å‘³", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""},
      {seq: 98, symptom: "æ·‹å·´çµå¤§", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 99, symptom: "é»‘ç—£è®Šå¤§è®Šå¤š", æ°”è¡€: "", å¾®å¾ªç¯: "", æ¯’ç´ : "â—‹", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "â—‹", æƒ…ç»ª: ""},
      {seq: 100, symptom: "å½¢é«”æ¶ˆç˜¦", æ°”è¡€: "â—‹", å¾®å¾ªç¯: "", æ¯’ç´ : "", è¡€è„‚: "", å¯’å‡‰æ¹¿: "", å…ç–«: "", æƒ…ç»ª: ""}
    ];

    // ç‹€æ…‹è¨­ç½®å‡½æ•¸
    const setStatus = text => {
      const statusText = document.getElementById('status-text');
      if (statusText) statusText.textContent = text;
    };

    // éŒ¯èª¤é¡¯ç¤ºå‡½æ•¸
    const showError = msg => {
      document.getElementById('status').classList.add('hidden');
      document.getElementById('result-card').classList.add('hidden');
      document.getElementById('checklist-section').classList.add('hidden');
      
      const el = document.getElementById('error-message');
      if (el) {
        el.innerHTML = `<p>${msg}</p><div class="mt-3 flex justify-center">
          <button onclick="window.location.reload()" class="text-primary hover:text-primary/80 font-medium">
            <i class="fa fa-refresh mr-1"></i> é‡æ–°å˜—è©¦
          </button></div>`;
        el.classList.remove('hidden');
      }
    };

    // è¨ˆç®—å‰©é¤˜å¤©æ•¸å‡½æ•¸
    const calculateRemainingDaysByDate = (expiryDateStr) => {
      try {
        if (expiryDateStr === PERMANENT_EXPIRY_DATE) {
          return { displayDate: "æ°¸ä¹…æœ‰æ•ˆ", remainingDays: "æ°¸ä¹…æœ‰æ•ˆ" };
        }

        const dateRegex = /^\d{4}[-\/]\d{2}[-\/]\d{2}$/;
        if (!dateRegex.test(expiryDateStr)) {
          return { displayDate: "æ ¼å¼éŒ¯èª¤", remainingDays: "æ ¼å¼éŒ¯èª¤" };
        }

        const normalizedDateStr = expiryDateStr.replace(/-/g, '/');
        const [year, month, day] = normalizedDateStr.split('/').map(Number);
        
        const expiryDate = new Date(Date.UTC(year, month - 1, day));
        const today = new Date();
        const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

        if (isNaN(expiryDate.getTime())) {
          return { displayDate: "æ—¥æœŸç„¡æ•ˆ", remainingDays: "æ—¥æœŸç„¡æ•ˆ" };
        }

        const timeDiff = expiryDate - todayUTC;
        const remainingDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

        const formattedDate = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
        let remainingDaysText;
        
        if (remainingDays < 0) {
          remainingDaysText = "å·²éæœŸ";
        } else if (remainingDays === 0) {
          remainingDaysText = "æœ€å¾Œ1å¤©";
        } else {
          remainingDaysText = `${remainingDays} å¤©`;
        }

        return { displayDate: formattedDate, remainingDays: remainingDaysText };
      } catch (error) {
        console.error("åŸºæ–¼æ—¥æœŸè¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š", error, "æ—¥æœŸå­—ç¬¦ä¸²ï¼š", expiryDateStr);
        return { displayDate: "è¨ˆç®—éŒ¯èª¤", remainingDays: "è¨ˆç®—éŒ¯èª¤" };
      }
    };

    // æ¸²æŸ“ç—‡ç‹€å¡ç‰‡
    function renderSymptomCards() {
      try {
        const container = document.getElementById('symptoms-container');
        if (!container) {
          console.error("ç—‡ç‹€å®¹å™¨æœªæ‰¾åˆ°");
          return false;
        }

        container.innerHTML = '';

        fullSymptomData.forEach(symptom => {
          // æ”¶é›†ç›¸é—œçš„å¥åº·è¦ç´ 
          const relatedFactors = [];
          Object.entries(factorStyles).forEach(([key, style]) => {
            if (symptom[key] === "â—‹") {
              relatedFactors.push(`<span class="factor-tag ${style.className}">${style.label}</span>`);
            }
          });

          // å»ºç«‹ä¸‹æ‹‰é¸å–®é¸é …HTML
          const durationOptionsHtml = durationOptions.map(option => 
            `<option value="${option.value}">${option.label}</option>`
          ).join('');

          const severityOptionsHtml = severityOptions.map(option => 
            `<option value="${option.value}">${option.label}</option>`
          ).join('');

          // å»ºç«‹ç—‡ç‹€å¡ç‰‡
          const card = document.createElement('div');
          card.className = 'symptom-card bg-white border border-gray-200 rounded-lg p-4 symptom-card-hover';
          card.dataset.seq = symptom.seq;
          card.innerHTML = `
            <div class="flex items-start gap-3">
              <!-- å‹¾é¸æ¡† -->
              <div class="flex-shrink-0 mt-1">
                <input type="checkbox" id="symptom-${symptom.seq}" class="symptom-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary" data-seq="${symptom.seq}">
              </div>
              
              <!-- ç—‡ç‹€å…§å®¹ -->
              <div class="flex-1">
                <div class="flex justify-between items-start mb-2">
                  <label for="symptom-${symptom.seq}" class="text-gray-800 font-medium cursor-pointer">
                    <span class="text-primary mr-1">[${symptom.seq}]</span>${symptom.symptom}
                  </label>
                </div>
                
                <!-- ç›¸é—œå¥åº·è¦ç´  -->
                <div class="flex flex-wrap gap-1 mb-3">
                  ${relatedFactors.length > 0 ? relatedFactors.join('') : '<span class="factor-tag bg-gray-100 text-gray-500">ç„¡ç›¸é—œè¦ç´ </span>'}
                </div>
                
                <!-- è©³ç´°è³‡è¨Šï¼ˆé è¨­éš±è—ï¼Œå‹¾é¸å¾Œé¡¯ç¤ºï¼‰ -->
                <div class="symptom-details hidden mt-3 pt-3 border-t border-gray-100">
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm text-gray-600 mb-1">æ™‚é–“é•·çŸ­</label>
                      <select class="duration-select w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-primary focus:border-primary">
                        ${durationOptionsHtml}
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm text-gray-600 mb-1">ç—‡ç‹€è¼•é‡</label>
                      <select class="severity-select w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-primary focus:border-primary">
                        ${severityOptionsHtml}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          container.appendChild(card);
        });

        // ç¶å®šå‹¾é¸æ¡†äº‹ä»¶
        bindCheckboxEvents();
        console.log("ç—‡ç‹€å¡ç‰‡æ¸²æŸ“å®Œæˆ");
        return true;
      } catch (error) {
        console.error("æ¸²æŸ“ç—‡ç‹€å¡ç‰‡å‡ºéŒ¯ï¼š", error);
        return false;
      }
    }

    // ç¶å®šå‹¾é¸æ¡†äº‹ä»¶
    function bindCheckboxEvents() {
      const checkboxes = document.querySelectorAll('.symptom-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const card = this.closest('.symptom-card');
          const details = card.querySelector('.symptom-details');
          
          if (this.checked) {
            details.classList.remove('hidden');
            card.classList.add('border-primary/50', 'bg-secondary/30');
          } else {
            details.classList.add('hidden');
            card.classList.remove('border-primary/50', 'bg-secondary/30');
            
            // é‡ç½®é¸æ“‡
            const durationSelect = card.querySelector('.duration-select');
            const severitySelect = card.querySelector('.severity-select');
            if (durationSelect) durationSelect.value = '';
            if (severitySelect) severitySelect.value = '';
          }
          
          // æ›´æ–°å·²é¸è¨ˆæ•¸
          updateSelectedCount();
        });
      });
    }

    // æ›´æ–°å·²é¸è¨ˆæ•¸
    function updateSelectedCount() {
      const checkedCount = document.querySelectorAll('.symptom-checkbox:checked').length;
      document.getElementById('selected-count').textContent = checkedCount;
      return checkedCount;
    }

    // å…¨é¸/å–æ¶ˆå…¨é¸/éæ¿¾åŠŸèƒ½
    function initControlButtons() {
      // å…¨é¸
      document.getElementById('select-all').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.symptom-checkbox');
        checkboxes.forEach(checkbox => {
          if (!checkbox.checked) {
            checkbox.checked = true;
            // è§¸ç™¼changeäº‹ä»¶
            checkbox.dispatchEvent(new Event('change'));
          }
        });
      });

      // å–æ¶ˆå…¨é¸
      document.getElementById('deselect-all').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.symptom-checkbox');
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            checkbox.checked = false;
            // è§¸ç™¼changeäº‹ä»¶
            checkbox.dispatchEvent(new Event('change'));
          }
        });
      });

      // åªçœ‹å·²é¸
      let filterActive = false;
      document.getElementById('filter-selected').addEventListener('click', function() {
        const cards = document.querySelectorAll('.symptom-card');
        const checkboxes = document.querySelectorAll('.symptom-checkbox');
        
        filterActive = !filterActive;
        
        if (filterActive) {
          this.classList.remove('bg-blue-500');
          this.classList.add('bg-red-500');
          this.innerHTML = '<i class="fa fa-filter mr-1"></i>é¡¯ç¤ºå…¨éƒ¨';
          
          // éš±è—æœªå‹¾é¸çš„å¡ç‰‡
          cards.forEach((card, index) => {
            if (!checkboxes[index].checked) {
              card.classList.add('hidden');
            }
          });
        } else {
          this.classList.remove('bg-red-500');
          this.classList.add('bg-blue-500');
          this.innerHTML = '<i class="fa fa-filter mr-1"></i>åªçœ‹å·²é¸';
          
          // é¡¯ç¤ºæ‰€æœ‰å¡ç‰‡
          cards.forEach(card => {
            card.classList.remove('hidden');
          });
        }
      });

      // æäº¤æŒ‰éˆ•
      document.getElementById('submit-checklist').addEventListener('click', function() {
        const selectedCount = updateSelectedCount();
        
        if (selectedCount === 0) {
          alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç—‡ç‹€');
          return;
        }
        
        // é©—è­‰å·²é¸ç—‡ç‹€æ˜¯å¦éƒ½å¡«å¯«äº†è©³ç´°è³‡è¨Š
        const checkedCheckboxes = document.querySelectorAll('.symptom-checkbox:checked');
        let isValid = true;
        
        checkedCheckboxes.forEach(checkbox => {
          const card = checkbox.closest('.symptom-card');
          const duration = card.querySelector('.duration-select').value;
          const severity = card.querySelector('.severity-select').value;
          
          if (!duration || !severity) {
            isValid = false;
            // é«˜äº®æœªå¡«å¯«çš„å¡ç‰‡
            card.classList.add('border-red-500');
            setTimeout(() => {
              card.classList.remove('border-red-500');
            }, 2000);
          }
        });
        
        if (!isValid) {
          alert('éƒ¨åˆ†å·²é¸ç—‡ç‹€æœªå¡«å¯«å®Œæ•´è³‡è¨Šï¼Œè«‹æª¢æŸ¥å¾Œå†æäº¤');
          return;
        }
        
        // æ”¶é›†æäº¤æ•¸æ“š
        const submitData = collectSubmitData();
        
        // èª¿ç”¨å¾Œç«¯æäº¤ï¼ˆé€™è£¡å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚ä¿®æ”¹ï¼‰
        submitChecklistData(submitData);
      });

      // é—œé–‰æ¨¡æ…‹æ¡†
      document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('success-modal').classList.add('hidden');
        // å¯ä»¥é¸æ“‡é‡ç½®è¡¨å–®æˆ–ç•™åœ¨ç•¶é 
        // resetChecklist();
      });
    }

    // æ”¶é›†æäº¤æ•¸æ“š
    function collectSubmitData() {
      const result = {
        userId: liff.getDecodedIDToken()?.sub || '',
        displayName: liff.getProfile()?.displayName || 'æœªçŸ¥ç”¨æˆ¶',
        submitTime: new Date().toISOString(),
        selectedSymptoms: []
      };

      const checkedCheckboxes = document.querySelectorAll('.symptom-checkbox:checked');
      checkedCheckboxes.forEach(checkbox => {
        const seq = checkbox.dataset.seq;
        const card = checkbox.closest('.symptom-card');
        const symptomName = card.querySelector('label').textContent.replace(/^\[\d+\]/, '').trim();
        const duration = card.querySelector('.duration-select').value;
        const severity = card.querySelector('.severity-select').value;
        
        // è½‰æ›ç‚ºæ˜“è®€çš„æ–‡å­—
        const durationText = durationOptions.find(opt => opt.value === duration)?.label || '';
        const severityText = severityOptions.find(opt => opt.value === severity)?.label || '';
        
        result.selectedSymptoms.push({
          seq: parseInt(seq),
          symptom: symptomName,
          duration: duration,
          durationText: durationText,
          severity: severity,
          severityText: severityText
        });
      });

      return result;
    }

    // æäº¤è‡ªæª¢è¡¨æ•¸æ“šåˆ°å¾Œç«¯
    function submitChecklistData(data) {
      console.log("æäº¤è‡ªæª¢è¡¨æ•¸æ“šï¼š", data);
      
      // é€™è£¡å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚ä¿®æ”¹æäº¤æ–¹å¼
      $.ajax({
        url: GAS_URL,
        dataType: 'jsonp',
        jsonp: 'callback',
        timeout: JSONP_TIMEOUT,
        data: {
          action: 'submitChecklist',
          data: JSON.stringify(data)
        },
        success: function(resp) {
          console.log("æäº¤æˆåŠŸï¼š", resp);
          document.getElementById('success-modal').classList.remove('hidden');
        },
        error: function(xhr, status, error) {
          console.error("æäº¤å¤±æ•—ï¼š", status, error);
          alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      });
    }

    // é‡ç½®è‡ªæª¢è¡¨
    function resetChecklist() {
      const checkboxes = document.querySelectorAll('.symptom-checkbox');
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          checkbox.checked = false;
          checkbox.dispatchEvent(new Event('change'));
        }
      });
      
      // é—œé–‰éæ¿¾
      const filterBtn = document.getElementById('filter-selected');
      if (filterBtn.classList.contains('bg-red-500')) {
        filterBtn.click();
      }
    }

    // å¼·åˆ¶é¡¯ç¤ºè‡ªæª¢è¡¨å€åŸŸ
    function forceShowChecklist() {
      try {
        const checklistSection = document.getElementById('checklist-section');
        if (!checklistSection) {
          console.error("è‡ªæª¢è¡¨å€åŸŸå…ƒç´ æœªæ‰¾åˆ°");
          alert("è‡ªæª¢è¡¨åŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦");
          return false;
        }

        // ç§»é™¤hiddené¡ï¼Œç¢ºä¿é¡¯ç¤º
        checklistSection.classList.remove('hidden');
        checklistSection.style.display = 'block'; // å¼·åˆ¶é¡¯ç¤ºï¼Œé˜²æ­¢CSSå½±éŸ¿
        
        // æ¸²æŸ“ç—‡ç‹€å¡ç‰‡
        const renderSuccess = renderSymptomCards();
        if (renderSuccess) {
          // åˆå§‹åŒ–æ§åˆ¶æŒ‰éˆ•
          initControlButtons();
          
          // æ»¾å‹•åˆ°è‡ªæª¢è¡¨å€åŸŸ
          setTimeout(() => {
            checklistSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }
        
        console.log("è‡ªæª¢è¡¨å€åŸŸå·²å¼·åˆ¶é¡¯ç¤º");
        return true;
      } catch (error) {
        console.error("å¼·åˆ¶é¡¯ç¤ºè‡ªæª¢è¡¨å‡ºéŒ¯ï¼š", error);
        alert("è‡ªæª¢è¡¨é¡¯ç¤ºå¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦");
        return false;
      }
    }

    // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log("é é¢åŠ è¼‰å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–");

      // åˆå§‹åŒ– LIFF
      setStatus('æ­£åœ¨åˆå§‹åŒ– LIFF...');
      liff.init({ liffId: LIFF_ID }, { disableRedirect: true })
        .then(() => {
          console.log("LIFF åˆå§‹åŒ–æˆåŠŸ");
          if (!liff.isLoggedIn()) {
            console.log("ç”¨æˆ¶æœªç™»éŒ„ï¼Œè·³è½‰ç™»éŒ„");
            liff.login();
          } else {
            console.log("ç”¨æˆ¶å·²ç™»éŒ„ï¼Œé–‹å§‹é©—è­‰ä¿¡æ¯");
            getProfileAndVerify();
          }
        })
        .catch(err => {
          console.error("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);
          showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
        });
    });

    // ç²å–ç”¨æˆ¶ä¿¡æ¯ä¸¦é©—è­‰
    function getProfileAndVerify() {
      setStatus('é©—è­‰ä½¿ç”¨è€…è³‡è¨Šä¸­...');
      liff.getProfile()
        .then(profile => {
          console.log("ç²å–ç”¨æˆ¶ä¿¡æ¯æˆåŠŸï¼š", profile);
          callGasBackend(profile.userId, profile.displayName || 'æœªçŸ¥ç”¨æˆ¶');
        })
        .catch(err => {
          console.error("ç²å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š", err);
          showError('å–å¾—ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š' + err.message);
        });
    }

    // èª¿ç”¨GASå¾Œç«¯
    function callGasBackend(userId, displayName) {
      console.log("èª¿ç”¨å¾Œç«¯é©—è­‰ç”¨æˆ¶ï¼š", userId, displayName);
      $.ajax({
        url: GAS_URL,
        dataType: 'jsonp',
        jsonp: 'callback',
        timeout: JSONP_TIMEOUT,
        data: { 
          userId: userId, 
          displayName: displayName,
          action: 'verifyUser',
          needExpiryDate: true
        },
        success: function(resp) {
          console.log("å¾Œç«¯è¿”å›æ•¸æ“šï¼š", resp);
          if (resp.status === "error") {
            showError(resp.message);
          } else {
            renderResult(resp);
          }
        },
        error: function(xhr, status, error) {
          console.error("AJAX éŒ¯èª¤ï¼š", status, error);
          let errorMsg = 'èˆ‡ä¼ºæœå™¨é€šè¨Šå¤±æ•—';
          if (status === 'timeout') errorMsg = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥';
          else if (status === 'parsererror') errorMsg = 'æ•¸æ“šè§£æéŒ¯èª¤';
          showError(errorMsg);
        }
      });
    }

    // æ¸²æŸ“é©—è­‰çµæœå’Œè‡ªæª¢è¡¨
    function renderResult(resp) {
      console.log("é–‹å§‹æ¸²æŸ“é©—è­‰çµæœå’Œè‡ªæª¢è¡¨");
      
      // éš±è—ç‹€æ…‹å’ŒéŒ¯èª¤ä¿¡æ¯
      document.getElementById('status').classList.add('hidden');
      document.getElementById('error-message').classList.add('hidden');

      // æ¸²æŸ“çµæœå¡ç‰‡
      const card = document.getElementById('result-card');
      const main = document.getElementById('result-main');
      const details = document.getElementById('result-details');

      const isProUser = resp.isAdmin === true;
      const userName = resp.displayName || 'æœªçŸ¥ç”¨æˆ¶';
      const expiryDateStr = resp.expiryDate || resp.endDate || resp.expireDate || '';

      if (isProUser) {
        const { displayDate, remainingDays } = calculateRemainingDaysByDate(expiryDateStr);
        main.innerHTML = `<span class="text-primary"><i class="fa fa-check-circle mr-1"></i>å°ˆæ¥­ç”¨æˆ¶é©—è­‰é€šé</span>`;
        details.innerHTML = `ç”¨æˆ¶åç¨±ï¼š${userName}<br>
                           ä½¿ç”¨æœŸé™ï¼š${displayDate}<br>
                           å‰©é¤˜å¤©æ•¸ï¼š${remainingDays}`;
      } else {
        const usageCount = resp.usageCount || 0;
        const remainingTimes = Math.max(0, 3 - usageCount);
        
        // æ™®é€šç”¨æˆ¶å‰©é¤˜æ¬¡æ•¸ç‚º0æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        if (remainingTimes <= 0) {
          main.innerHTML = `<span class="text-orange-600"><i class="fa fa-exclamation-circle mr-1"></i>æ™®é€šç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œ</span>`;
          details.innerHTML = `ç”¨æˆ¶åç¨±ï¼š${userName}<br>
                             ä½¿ç”¨æœŸé™ï¼š-<br>
                             å‰©é¤˜æ¬¡æ•¸ï¼š${remainingTimes} æ¬¡<br>
                             æç¤ºï¼šè«‹è¯ç¹«ç®¡ç†å“¡å‡ç´šç‚ºå°ˆæ¥­ç”¨æˆ¶ç¹¼çºŒä½¿ç”¨`;
          
          // é¡¯ç¤ºçµæœå¡ç‰‡
          card.classList.remove('hidden');
          return; // çµ‚æ­¢åŸ·è¡Œï¼Œä¸é¡¯ç¤ºè‡ªæª¢è¡¨
        } else {
          main.innerHTML = `<span class="text-gray-600"><i class="fa fa-user mr-1"></i>æ™®é€šç”¨æˆ¶é©—è­‰é€šé</span>`;
          details.innerHTML = `ç”¨æˆ¶åç¨±ï¼š${userName}<br>
                             ä½¿ç”¨æœŸé™ï¼š-<br>
                             å‰©é¤˜æ¬¡æ•¸ï¼š${remainingTimes} æ¬¡`;
        }
      }

      // é¡¯ç¤ºçµæœå¡ç‰‡
      card.classList.remove('hidden');
      console.log("çµæœå¡ç‰‡å·²é¡¯ç¤º");

      // é¡¯ç¤ºè‡ªæª¢è¡¨å€åŸŸ
      setTimeout(() => {
        forceShowChecklist();
      }, 100);
    }
  </script>
</body>
</html>
