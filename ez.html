<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ§¬ å½¥å½¬ è‡ªæª¢è¡¨ç³»çµ±</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
tailwind.config={theme:{extend:{colors:{primary:'#008C76',secondary:'#E8F9F7',accent:'#FFD700',dark:'#1A202C',lightBg:'#F9FAFB',neutral:'#F3F4F6',cardBg:'#FFFFFF',textPrimary:'#1E293B',textSecondary:'#64748B'},fontFamily:{sans:['Noto Sans TC','sans-serif','system-ui'],display:['Noto Sans TC','sans-serif','system-ui']},boxShadow:{'elevation-1':'0 2px 8px rgba(0, 0, 0, 0.06)','elevation-2':'0 4px 16px rgba(0, 0, 0, 0.08)','elevation-3':'0 8px 24px rgba(0, 0, 0, 0.12)','elevation-hover':'0 12px 32px rgba(0, 0, 0, 0.15)'}}}};
</script>
<style type="text/tailwindcss">
@layer utilities{.fade-in{animation:fadeIn 0.6s cubic-bezier(0.4,0,0.2,1);}.slide-up{animation:slideUp 0.5s cubic-bezier(0.34,1.56,0.64,1);}.scale-in{animation:scaleIn 0.4s cubic-bezier(0.34,1.56,0.64,1);}.pulse-subtle{animation:pulseSubtle 2s infinite;}.gradient-text{background-clip:text;-webkit-background-clip:text;color:transparent;}.card-hover{transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);}.btn-hover{transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);}.factor-tag{font-size:0.75rem;padding:0.2rem 0.4rem;border-radius:6px;font-weight:500;}.input-focus{@apply focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all;}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes slideUp{from{transform:translateY(30px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleIn{from{transform:scale(0.96);opacity:0;}to{transform:scale(1);opacity:1;}}
@keyframes pulseSubtle{0%,100%{opacity:1;}50%{opacity:0.8;}}
::-webkit-scrollbar{width:8px;height:8px;}
::-webkit-scrollbar-track{background:#F1F5F9;border-radius:4px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:#94A3B8;}
body{font-feature-settings:"palt";letter-spacing:0.02em;}
.symptom-card{min-height:120px;}
@media (max-width:640px){
.symptom-card{min-height:110px;}
.factor-tag{font-size:0.7rem;padding:0.15rem 0.3rem;}
#symptoms-container{gap:2px;}
.btn-hover{transform:scale(1.02);}
.result-summary{font-size:0.9rem;}
.info-grid{grid-template-columns:repeat(2,1fr);gap:0.5rem;}
}
.info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;}
.info-item{display:flex;justify-content:space-between;}
.severity-note{font-size:0.65rem;color:#94A3B8;margin-top:2px;}
</style>
</head>
<body class="bg-lightBg min-h-screen flex flex-col p-2 md:p-4">
<div class="max-w-5xl w-full bg-cardBg rounded-2xl shadow-elevation-2 overflow-hidden fade-in self-center">
<div class="bg-gradient-to-r from-primary to-[#006658] p-4 md:p-6 text-white text-center relative overflow-hidden">
<div class="absolute top-0 left-0 w-32 h-32 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
<div class="absolute bottom-0 right-0 w-48 h-48 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3"></div>
<div class="relative z-10">
<div class="inline-flex items-center justify-center w-14 h-14 bg-white/10 backdrop-blur-sm rounded-full mb-3 pulse-subtle">
<i class="fa fa-heartbeat text-2xl text-accent"></i>
</div>
<h1 class="text-xl md:text-2xl font-bold mb-1 tracking-wide">ğŸ§¬ å½¥å½¬ è‡ªæª¢è¡¨ç³»çµ±</h1>
<p class="text-white/90 text-sm md:text-base font-light">å°ˆæ¥­å¥åº·è©•ä¼° Â· ç²¾å‡†å°æ‡‰ä¸ƒå¤§å¥åº·è¦ç´ </p>
</div>
</div>
<div class="p-3 md:p-5">
<div id="status" class="flex items-center justify-center py-6 text-textPrimary text-center">
<div class="text-center">
<div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-3"></div>
<p id="status-text" class="text-base">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
</div>
</div>
<div id="error-message" class="hidden bg-red-50 border border-red-100 text-red-700 px-4 py-3 rounded-xl mb-4 shadow-sm">
<div class="flex items-start">
<i class="fa fa-exclamation-circle text-red-500 mt-1 mr-2 text-lg"></i>
<div id="error-content"></div>
</div>
</div>
<div id="result-card" class="hidden bg-gradient-to-r from-secondary to-[#F0FAF8] border border-primary/15 rounded-2xl p-4 mb-4 text-center slide-up relative overflow-hidden">
<div class="absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-full translate-x-1/2 -translate-y-1/2"></div>
<div class="relative z-10">
<div id="result-main" class="text-lg md:text-xl font-bold mb-2 text-textPrimary"></div>
<div id="result-details" class="text-sm text-textSecondary space-y-1 md:space-y-1.5"></div>
<div class="w-20 h-0.5 bg-primary/20 mx-auto my-2"></div>
<p class="text-xs text-textSecondary/80"><i class="fa fa-info-circle text-primary mr-1"></i>è«‹æ ¹æ“šè‡ªèº«ç‹€æ³å¦‚å¯¦å¡«å¯«ï¼Œç³»çµ±å°‡ç‚ºæ‚¨æä¾›å°ˆæ¥­åƒè€ƒ</p>
</div>
</div>
<div id="user-info-section" class="hidden scale-in bg-neutral rounded-2xl p-3 md:p-4 mb-4 shadow-elevation-1">
<div class="text-center mb-3">
<h2 class="text-lg md:text-xl font-bold text-textPrimary mb-1"><span class="gradient-text bg-gradient-to-r from-primary to-[#006658]">ç”¨æˆ¶åŸºæœ¬è³‡è¨Š</span></h2>
<p class="text-textSecondary max-w-2xl mx-auto text-xs">è«‹æ ¹æ“šå¯¦éš›æƒ…æ³å¡«å¯«ï¼Œå¹«åŠ©ç³»çµ±ç²¾ç¢ºè©•ä¼°</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">å§“å <span class="text-red-500">*</span></label>
<input type="text" id="user-name" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">å¹´é½¡ <span class="text-red-500">*</span></label>
<input type="number" id="user-age" min="0" max="120" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="è«‹è¼¸å…¥å¹´é½¡" required>
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">æ€§åˆ¥ <span class="text-red-500">*</span></label>
<select id="user-gender" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" required>
<option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
<option value="male">ç”·</option>
<option value="female">å¥³</option>
</select>
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">èº«é«˜ (cm)</label>
<input type="number" id="user-height" min="50" max="250" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="é¸å¡«">
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">é«”é‡ (kg)</label>
<input type="number" id="user-weight" min="10" max="200" step="0.1" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="é¸å¡«">
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">è¡€å£“ (mmHg)</label>
<input type="text" id="user-bp" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="é¸å¡«ï¼Œä¾‹ï¼š120æ”¶ç¸®å£“/80èˆ’å¼µå£“">
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">è¡€ç³–(HbA1c)</label>
<input type="number" id="user-glucose" min="3" max="15" step="0.1" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="ç³–åŒ–è¡€è‰²ç´ ">
</div>
<div class="space-y-1">
<label class="block text-xs font-medium text-textPrimary">è·æ¥­</label>
<input type="text" id="user-job" class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm input-focus bg-white" placeholder="é¸å¡«">
</div>
</div>
<div class="text-center">
<button id="next-to-checklist" class="bg-gradient-to-r from-primary to-[#006658] hover:from-[#007A69] hover:to-[#00594D] text-white font-bold py-2 px-5 rounded-xl shadow-elevation-2 transition btn-hover transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
<i class="fa fa-arrow-right mr-1.5"></i>ç¹¼çºŒå¡«å¯«è‡ªæª¢è¡¨
</button>
</div>
</div>
<div id="checklist-section" class="hidden scale-in">
<div class="mb-3 text-center">
<h2 class="text-lg md:text-xl font-bold text-textPrimary mb-1"><span class="gradient-text bg-gradient-to-r from-primary to-[#006658]">è‡ªæª¢è¡¨å¡«å¯«å€åŸŸ</span></h2>
<p class="text-textSecondary max-w-2xl mx-auto mb-2 text-xs">è«‹å‹¾é¸å°æ‡‰ç—‡ç‹€ä¸¦å¡«å¯«ç›¸é—œè³‡è¨Š</p>
<div class="mt-2 flex flex-wrap justify-center gap-1.5 text-xs">
<span class="bg-blue-50 text-blue-700 factor-tag">æ°£è¡€</span>
<span class="bg-green-50 text-green-700 factor-tag">å¾ªç’°</span>
<span class="bg-yellow-50 text-yellow-700 factor-tag">æ¯’ç´ </span>
</div>
<span class="bg-orange-50 text-orange-700 factor-tag">è¡€è„‚</span>
<span class="bg-purple-50 text-purple-700 factor-tag">å¯’æ¿•</span>
<span class="bg-pink-50 text-pink-700 factor-tag">å…ç–«</span>
<span class="bg-indigo-50 text-indigo-700 factor-tag">æƒ…ç·’</span>
</div>
</div>
<div class="bg-neutral rounded-2xl p-2 mb-3 shadow-elevation-1">
<div class="flex flex-wrap gap-1.5 mb-2">
<button id="filter-all" class="bg-primary text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-[#007A69] transition btn-hover shadow-elevation-1">
<i class="fa fa-th-list mr-1"></i>é¡¯ç¤ºå…¨éƒ¨
</button>
<button data-factor="æ°£è¡€" class="bg-blue-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-blue-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>æ°£è¡€
</button>
<button data-factor="å¾ªç’°" class="bg-green-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-green-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>å¾ªç’°
</button>
<button data-factor="æ¯’ç´ " class="bg-yellow-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-yellow-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>æ¯’ç´ 
</button>
<button data-factor="è¡€è„‚" class="bg-orange-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-orange-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>è¡€è„‚
</button>
<button data-factor="å¯’æ¿•" class="bg-purple-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-purple-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>å¯’æ¿•
</button>
<button data-factor="å…ç–«" class="bg-pink-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-pink-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>å…ç–«
</button>
<button data-factor="æƒ…ç·’" class="bg-indigo-600 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-indigo-700 transition btn-hover shadow-elevation-1">
<i class="fa fa-tag mr-1"></i>æƒ…ç·’
</button>
</div>
<div class="flex flex-wrap items-center justify-between gap-2">
<button id="filter-selected" class="bg-gray-700 text-white px-2.5 py-1 rounded-lg text-xs font-medium hover:bg-gray-800 transition btn-hover shadow-elevation-1">
<i class="fa fa-filter mr-1"></i>åªçœ‹å·²é¸
</button>
<div class="text-textPrimary text-sm font-medium">
å·²å‹¾é¸: <span id="selected-count" class="font-bold text-primary text-base">0</span>/95 å€‹ç—‡ç‹€
</div>
</div>
</div>
<div id="symptoms-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-4"></div>
<div class="text-center mt-4 mb-2">
<button id="back-to-info" class="bg-gray-200 hover:bg-gray-300 text-textPrimary font-bold py-1.5 px-4 rounded-xl shadow-elevation-1 transition btn-hover mr-2">
<i class="fa fa-arrow-left mr-1.5"></i>è¿”å›ä¿®æ”¹è³‡è¨Š
</button>
<button id="submit-checklist" class="bg-gradient-to-r from-primary to-[#006658] hover:from-[#007A69] hover:to-[#00594D] text-white font-bold py-2 px-5 rounded-xl shadow-elevation-2 transition btn-hover transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
<i class="fa fa-paper-plane mr-1.5"></i>æäº¤è‡ªæª¢è¡¨
</button>
<p class="text-xs text-textSecondary/70 mt-2">æäº¤å¾Œå°‡ç”Ÿæˆå°ˆæ¥­åƒè€ƒå ±å‘Šï¼Œè«‹ç¢ºä¿ä¿¡æ¯çœŸå¯¦æœ‰æ•ˆ</p>
</div>
</div>
</div>
</div>
<div id="success-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden fade-in p-2">
<div class="bg-cardBg rounded-2xl p-4 max-w-md w-full mx-2 text-center shadow-elevation-3 transform transition-all hover:shadow-elevation-hover">
<div id="report-summary" class="border border-gray-100 rounded-xl p-3 mb-3 bg-neutral/50 text-left result-summary">
<h4 class="text-sm font-medium text-textPrimary mb-2 flex items-center"><i class="fa fa-file-text-o text-primary mr-1.5"></i>å¥åº·å ±å‘Šæ‘˜è¦</h4>
<div id="summary-content" class="text-xs space-y-1.5"></div>

<script>
const LIFF_ID="2008578880-NznKeG2a";
const GAS_URL="https://script.google.com/macros/s/AKfycbykBtM2_PM7IZ-ZUU4tgTqVa1xGhVQFaZ523FXc4ivdLz_GZ09sdmL6s5zk7SdloFuG/exec";
const JSONP_TIMEOUT=12000;
const PERMANENT_EXPIRY_DATE="9999/12/31";
const factorStyles={
  æ°£è¡€:{className:'bg-blue-500/20 text-blue-400 font-bold',label:'æ°£è¡€'},
  å¾ªç’°:{className:'bg-green-500/20 text-green-400 font-bold',label:'å¾ªç’°'},
  æ¯’ç´ :{className:'bg-yellow-500/20 text-yellow-400 font-bold',label:'æ¯’ç´ '},
  è¡€è„‚:{className:'bg-orange-500/20 text-orange-400 font-bold',label:'è¡€è„‚'},
  å¯’æ¿•:{className:'bg-purple-500/20 text-purple-400 font-bold',label:'å¯’æ¿•'},
  å…ç–«:{className:'bg-pink-500/20 text-pink-400 font-bold',label:'å…ç–«'},
  æƒ…ç·’:{className:'bg-indigo-500/20 text-indigo-400 font-bold',label:'æƒ…ç·’'}
};
const durationOptions=[
  {value:'',label:'è«‹é¸æ“‡æ™‚é–“'},{value:'1w',label:'1å‘¨å…§'},{value:'1-3m',label:'1-3å€‹æœˆ'},
  {value:'3-6m',label:'3-6å€‹æœˆ'},{value:'6m-1y',label:'6å€‹æœˆ-1å¹´'},{value:'1-2y',label:'1-2å¹´'},
  {value:'2-5y',label:'2-5å¹´'},{value:'5y+',label:'5å¹´ä»¥ä¸Š'}
];
const severityOptions=[
  {value:'',label:'è«‹é¸æ“‡è¼•é‡'},{value:'mild',label:'è¼•åº¦ï¼ˆä¸å½±éŸ¿ç”Ÿæ´»ï¼‰'},
  {value:'moderate',label:'ä¸­åº¦ï¼ˆå¶çˆ¾å½±éŸ¿ï¼‰'},{value:'severe',label:'é‡åº¦ï¼ˆæ˜é¡¯å½±éŸ¿ï¼‰'}
];
const fullSymptomData=[
  {seq:1,symptom:"è¨˜æ†¶åŠ›ä¸‹é™",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:2,symptom:"æ€ç¶­æ–·é›»",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:3,symptom:"åæ‡‰é²éˆ",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:4,symptom:"å—œç¡",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:5,symptom:"å¤šå¤¢",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:6,symptom:"é ­æšˆ",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:7,symptom:"é ­ç–¼",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:8,symptom:"é ­éº»",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:9,symptom:"æšˆè»Š",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:10,symptom:"å¤±çœ ",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:11,symptom:"é ­é¢æ²¹è†©",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:12,symptom:"è„«ç™¼",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:13,symptom:"é ­é«®ç¨€å°‘",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:14,symptom:"æ˜“æ‰“å“ˆæ¬ ",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:15,symptom:"å¸¸å˜†æ°£",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:16,symptom:"çœ¼ä¹¾æ¾€",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:17,symptom:"çœ¼ç™¢",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:18,symptom:"çœ¼ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:19,symptom:"è¦–åŠ›æ¨¡ç³Š",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:20,symptom:"çœ¼å±å¤š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:21,symptom:"çœ¼æ€•å…‰æµæ·š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:22,symptom:"éº¥ç²’è…«",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:23,symptom:"è½åŠ›ä¸‹é™",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:24,symptom:"è€³ç™¢",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:25,symptom:"è€³é³´",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:26,symptom:"è€³ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:27,symptom:"è€³å±å¤š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:28,symptom:"è€³å…§æ½®æ¿•",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:29,symptom:"æ‰“é¼¾",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:30,symptom:"é¼»å¡",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:31,symptom:"æ„›æ‰“å™´åš",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:32,symptom:"å¸¸æµé¼»æ¶•",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:33,symptom:"é¼»ç‚",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:34,symptom:"æ„Ÿå†’æ™‚é–“é•·",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:35,symptom:"å—“å­ä¹¾",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:36,symptom:"å–‰åš¨ç™¢",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:37,symptom:"å–‰åš¨ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:38,symptom:"å’³å—½",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:39,symptom:"ç—°å¤š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:40,symptom:"å‘¼å¸å›°é›£",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:41,symptom:"å£è‹¦",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:42,symptom:"å£ä¹¾",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:43,symptom:"å£è‡­",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:44,symptom:"å£è…”æ½°ç˜",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:45,symptom:"èˆŒæ½°ç˜",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:46,symptom:"å˜´å”‡éº»",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:47,symptom:"èˆŒç¡¬",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:48,symptom:"èƒ¸æ‚¶æ°£çŸ­",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:49,symptom:"å¿ƒæ…Œå¿ƒæ‚¸",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:50,symptom:"å¿ƒçµç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:51,symptom:"æŒ‡ç”²å‡¹é™·",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:52,symptom:"åŠæœˆç—•å°‘",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:53,symptom:"æ‰‹è…³è„«çš®",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:54,symptom:"æ‰‹è…³å‡ºæ±—",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:55,symptom:"æ‰‹è…³æ¶¼",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:56,symptom:"æ‰‹è…³ç†±",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:57,symptom:"æ‰‹è¶³éº»æœ¨",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:58,symptom:"å››è‚¢ä¹åŠ›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:59,symptom:"éœè„ˆæ›²å¼µ",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:60,symptom:"é—œç¯€ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:61,symptom:"è‚©é…¸ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:62,symptom:"é ¸æ¤ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:63,symptom:"è…°é…¸ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:64,symptom:"å°¿æ¸¾æ¿",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:65,symptom:"å°¿å¤šæ²«",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:66,symptom:"å°¿æœ‰æ€ªå‘³",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:67,symptom:"å¤œå°¿å¤š",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:68,symptom:"ä¾¿ç§˜",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:69,symptom:"å¤§ä¾¿ä¸æˆå½¢",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:70,symptom:"ä¾¿æºä¸æ·¨",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:""},
  {seq:71,symptom:"ç¶“æœŸé ­ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:72,symptom:"æœˆç¶“é‡å°‘",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:73,symptom:"ç¶“æœŸæ™‚é•·",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:74,symptom:"ç¶“æœŸæ¨å¾Œ",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:75,symptom:"æœˆç¶“æœ‰è¡€å¡Š",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:76,symptom:"ä¹³è…ºå¢ç”Ÿ",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:77,symptom:"ç¶“æœŸè…°ç—›",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:78,symptom:"ç¶“æœŸæå‰",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:79,symptom:"æœˆç¶“é‡å¤š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:80,symptom:"ä¸æ„›èªªè©±",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:81,symptom:"æƒ¡å¿ƒ",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:82,symptom:"èƒƒè„¹",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:83,symptom:"èƒƒé…¸",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:84,symptom:"èƒƒç—›",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:85,symptom:"æ¶ˆåŒ–ä¸è‰¯",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:86,symptom:"è‚¥èƒ–",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"",æƒ…ç·’:"â—‹"},
  {seq:87,symptom:"çš®è†šç™¢",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:88,symptom:"æ¿•ç–¹",æ°£è¡€:"â—‹",å¾ªç’°:"â—‹",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:89,symptom:"å„ç¨®éæ•",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:90,symptom:"ç—¤ç˜¡",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:91,symptom:"è„‚è‚ªç˜¤",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"â—‹",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:92,symptom:"èº«é«”ç•°å‘³",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"â—‹",å¯’æ¿•:"",å…ç–«:"",æƒ…ç·’:""},
  {seq:93,symptom:"æ·‹å·´è…«å¤§",æ°£è¡€:"",å¾ªç’°:"â—‹",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"â—‹",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"},
  {seq:94,symptom:"é»‘ç—£è®Šå¤§è®Šå¤š",æ°£è¡€:"",å¾ªç’°:"",æ¯’ç´ :"â—‹",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:""},
  {seq:95,symptom:"å½¢é«”æ¶ˆç˜¦",æ°£è¡€:"â—‹",å¾ªç’°:"",æ¯’ç´ :"",è¡€è„‚:"",å¯’æ¿•:"",å…ç–«:"â—‹",æƒ…ç·’:"â—‹"}
];

const setStatus=text=>{
  const e=document.getElementById('status-text');
  e&&(e.textContent=text);
};

const showError=msg=>{
  document.getElementById('status').classList.add('hidden');
  document.getElementById('result-card').classList.add('hidden');
  document.getElementById('user-info-section').classList.add('hidden');
  document.getElementById('checklist-section').classList.add('hidden');
  const e=document.getElementById('error-message'),c=document.getElementById('error-content');
  e&&c&&(c.innerHTML=`<p class="font-medium font-bold">${msg}</p><div class="mt-3 flex justify-center"><button onclick="window.location.reload()" class="text-primary hover:text-[#007A69] font-medium flex items-center gap-1 font-bold"><i class="fa fa-refresh"></i> é‡æ–°å˜—è©¦</button></div>`,e.classList.remove('hidden'));
};

const calculateRemainingDaysByDate=expiryDateStr=>{
  try{
    if(expiryDateStr===PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ"};
    const r=/^\d{4}[-\/]\d{2}[-\/]\d{2}$/;
    if(!r.test(expiryDateStr))return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤"};
    const d=expiryDateStr.replace(/-/g,'/').split('/').map(Number),ed=new Date(Date.UTC(d[0],d[1]-1,d[2])),td=new Date(),tutc=new Date(Date.UTC(td.getFullYear(),td.getMonth(),td.getDate()));
    if(isNaN(ed.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ"};
    const tdiff=ed-tutc,rd=Math.ceil(tdiff/(1000*3600*24)),fd=`${d[0]}/${String(d[1]).padStart(2,'0')}/${String(d[2]).padStart(2,'0')}`;
    let rt;
    if(rd<0)rt="<span class='text-red-500 font-bold'>å·²éæœŸ</span>";
    else if(rd===0)rt="<span class='text-orange-500 font-bold'>æœ€å¾Œ1å¤©</span>";
    else if(rd<=30)rt=`<span class='text-orange-500 font-bold'>${rd} å¤©</span>`;
    else rt=`${rd} å¤©`;
    return{displayDate:fd,remainingDays:rt};
  }catch(e){
    console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š",e,expiryDateStr);
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤"};
  }
};

function renderSymptomCards(){
  try{
    const c=document.getElementById('symptoms-container');
    if(!c)return false;
    c.innerHTML='';
    fullSymptomData.forEach((s,i)=>{
      const rf=[],doh=durationOptions.map(o=>`<option value="${o.value}" class="font-bold">${o.label}</option>`).join(''),soh=severityOptions.map(o=>`<option value="${o.value}" class="font-bold">${o.label}</option>`).join('');
      Object.entries(factorStyles).forEach(([k,st])=>s[k]==="â—‹"&&rf.push(`<span class="factor-tag ${st.className} font-bold">${st.label}</span>`));
      const cd=document.createElement('div');
      cd.className='symptom-card bg-gray-800 border border-gray-700 rounded-xl p-2 shadow-sm card-hover font-bold';
      cd.dataset.seq=s.seq;
      cd.dataset.factors=Object.entries(factorStyles).filter(([k])=>s[k]==="â—‹").map(([k])=>k).join(',');
      cd.style.opacity='0';
      cd.style.transform='translateY(20px)';
      cd.style.transition='all 0.3s cubic-bezier(0.34,1.56,0.64,1)';
      cd.style.transitionDelay=`${i*15}ms`;
      cd.innerHTML=`
<div class="flex items-start gap-2 font-bold">
  <div class="flex-shrink-0 mt-1 font-bold"><input type="checkbox" id="symptom-${s.seq}" class="symptom-checkbox h-4 w-4 text-primary rounded border-gray-600 input-focus font-bold" data-seq="${s.seq}"></div>
  <div class="flex-1 font-bold">
    <div class="flex justify-between items-start mb-1 font-bold"><label for="symptom-${s.seq}" class="text-gray-200 font-bold cursor-pointer text-sm font-bold"><span class="text-primary mr-1 font-bold">[${s.seq}]</span>${s.symptom}</label></div>
    <div class="flex flex-wrap gap-1 mb-1 font-bold">${rf.length>0?rf.join(''):'<span class="factor-tag bg-gray-700 text-gray-400 font-bold">ç„¡ç›¸é—œè¦ç´ </span>'}</div>
    <div class="symptom-details hidden mt-2 pt-2 border-t border-gray-700 font-bold">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 font-bold">
        <div class="font-bold"><label class="block text-xs text-gray-400 mb-1 font-bold">æ™‚é–“é•·çŸ­</label><select class="duration-select w-full border border-gray-700 rounded-lg px-2 py-1 text-xs input-focus bg-gray-800 text-gray-200 font-bold">${doh}</select></div>
        <div class="font-bold"><label class="block text-xs text-gray-400 mb-1 font-bold">ç—‡ç‹€è¼•é‡</label><select class="severity-select w-full border border-gray-700 rounded-lg px-2 py-1 text-xs input-focus bg-gray-800 text-gray-200 font-bold">${soh}</select><div class="severity-note text-gray-500 text-xs font-bold">å‚™æ³¨ï¼šè¼•åº¦(ä¸å½±éŸ¿ç”Ÿæ´»)ã€ä¸­åº¦(å¶çˆ¾å½±éŸ¿)ã€é‡åº¦(æ˜é¡¯å½±éŸ¿)</div></div>
      </div>
    </div>
  </div>
</div>`;
      c.appendChild(cd);
      setTimeout(()=>{
        cd.style.opacity='1';
        cd.style.transform='translateY(0)';
      },50);
    });
    bindCheckboxEvents();
    return true;
  }catch(e){
    console.error("æ¸²æŸ“ç—‡ç‹€å¡ç‰‡å‡ºéŒ¯ï¼š",e);
    return false;
  }
}

function bindCheckboxEvents(){
  document.querySelectorAll('.symptom-checkbox').forEach(cb=>{
    cb.addEventListener('change',function(){
      const cd=this.closest('.symptom-card'),dt=cd.querySelector('.symptom-details');
      this.checked?(dt.classList.remove('hidden'),cd.classList.add('border-primary/30','bg-gray-700','shadow-md')):(dt.classList.add('hidden'),cd.classList.remove('border-primary/30','bg-gray-700','shadow-md'),cd.querySelector('.duration-select').value='',cd.querySelector('.severity-select').value='');
      updateSelectedCount();
    });
  });
}

function updateSelectedCount(){
  const cnt=document.querySelectorAll('.symptom-checkbox:checked').length;
  document.getElementById('selected-count').textContent=cnt;
  return cnt;
}

function initFilterButtons(){
  const fb=document.querySelectorAll('[data-factor], #filter-all');
  let cf='all',sos=false;
  fb.forEach(b=>{
    b.addEventListener('click',function(){
      fb.forEach(bt=>bt.classList.remove('shadow-md','scale-105'));
      this.classList.add('shadow-md','scale-105');
      cf=this.id==='filter-all'?'all':this.dataset.factor;
      applyFilters();
    });
  });
  document.getElementById('filter-selected').addEventListener('click',function(){
    sos=!sos;
    if(sos){
      this.classList.remove('bg-gray-700','hover:bg-gray-600');
      this.classList.add('bg-red-900/50','hover:bg-red-800/50','shadow-md');
      this.innerHTML='<i class="fa fa-filter mr-1"></i>é¡¯ç¤ºå…¨éƒ¨å·²å‹¾é¸';
    }else{
      this.classList.remove('bg-red-900/50','hover:bg-red-800/50','shadow-md');
      this.classList.add('bg-gray-700','hover:bg-gray-600');
      this.innerHTML='<i class="fa fa-filter mr-1"></i>åªçœ‹å·²é¸';
    }
    applyFilters();
  });
  function applyFilters(){
    document.querySelectorAll('.symptom-card').forEach(cd=>{
      let ss=true;
      if(cf!=='all'){
        const cfs=cd.dataset.factors.split(',');
        ss=cfs.includes(cf);
      }
      if(sos&&ss)ss=cd.querySelector('.symptom-checkbox').checked;
      if(ss){
        cd.style.display='block';
        setTimeout(()=>{
          cd.style.opacity='1';
          cd.style.transform='translateY(0)';
        },10);
      }else{
        cd.style.opacity='0';
        cd.style.transform='translateY(10px)';
        setTimeout(()=>{
          cd.style.display='none';
        },300);
      }
    });
  }
}

function organizeReportData(submitData){
  const {userBasicInfo,selectedSymptoms,displayName,submitTime}=submitData,fs={æ°£è¡€:[],å¾ªç’°:[],æ¯’ç´ :[],è¡€è„‚:[],å¯’æ¿•:[],å…ç–«:[],æƒ…ç·’:[]};
  selectedSymptoms.forEach(s=>{
    const os=fullSymptomData.find(ss=>ss.seq===s.seq);
    os&&Object.keys(fs).forEach(f=>os[f]==="â—‹"&&fs[f].push({name:s.symptom,duration:s.durationText,severity:s.severityText}));
  });
  const factorCounts = Object.entries(fs).map(([key, list]) => ({name: factorStyles[key].label,count: list.length,key: key})).filter(item => item.count > 0).sort((a, b) => b.count - a.count);
  const topFactors = factorCounts.slice(0, 2);
  const ffs=Object.fromEntries(Object.entries(fs).filter(([_,f])=>f.length>0)),fui={
    å§“å:userBasicInfo.name||'æœªå¡«å¯«',
    å¹´é½¡:userBasicInfo.age?`${userBasicInfo.age}æ­²`:'æœªå¡«å¯«',
    æ€§åˆ¥:userBasicInfo.gender==='male'?'ç”·':userBasicInfo.gender==='female'?'å¥³':'æœªå¡«å¯«',
    èº«é«˜:userBasicInfo.height?`${userBasicInfo.height}cm`:'æœªå¡«å¯«',
    é«”é‡:userBasicInfo.weight?`${userBasicInfo.weight}kg`:'æœªå¡«å¯«',
    è¡€å£“:userBasicInfo.bp||'æœªå¡«å¯«',
    è¡€ç³–:userBasicInfo.glucose?`${userBasicInfo.glucose}%`:'æœªå¡«å¯«',
    è·æ¥­:userBasicInfo.job||'æœªå¡«å¯«',
    æäº¤æ™‚é–“:new Date(submitTime).toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})
  };
  const totalSymptomCount = fullSymptomData.length;
  const allSelectedSymptoms = new Set();
  Object.values(ffs).forEach(factorSymptoms => {
    factorSymptoms.forEach(symptom => allSelectedSymptoms.add(symptom.name));
  });
  const selectedTotal = allSelectedSymptoms.size;
  let st=`ğŸ§¬ å½¥å½¬è‡ªæª¢è¡¨ç³»çµ±\n
ğŸ‘¤ å§“åï¼š${fui.å§“å} \nğŸ•¶ï¸ å¹´é½¡ï¼š${fui.å¹´é½¡}\n
ğŸ“Š ç¸½é¸å–ç—‡ç‹€æ•¸ï¼š\n${selectedTotal} é … (å…±${totalSymptomCount}ç¨®ç—‡ç‹€)\n
ğŸ¯ èª¿æ•´æ–¹å‘ï¼š\n${topFactors.length > 0 ? (topFactors.length === 1 ? `${topFactors[0].name} (${topFactors[0].count}é …)` : `${topFactors[0].name} (${topFactors[0].count}é …)\n${topFactors[1].name} (${topFactors[1].count}é …)`) : 'ç„¡'}
`;
  return {formattedUserInfo:fui,factorSymptoms:ffs,summaryText:st,totalSymptomCount, selectedTotal, topFactors};
}

function initControlButtons(){
  const styleButtons = () => {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if(!btn.classList.contains('custom-styled')) {
        btn.classList.add('custom-styled', 'px-6', 'py-2.5', 'rounded-lg', 'font-bold', 'transition-all', 'duration-300', 'shadow-sm', 'hover:shadow-md', 'transform', 'hover:-translate-y-0.5', 'active:translate-y-0');
        btn.classList.remove('px-8', 'py-3');
      }
    });
  };
  document.getElementById('next-to-checklist').addEventListener('click',function(){
    const n=document.getElementById('user-name').value.trim(),a=document.getElementById('user-age').value.trim(),g=document.getElementById('user-gender').value;
    if(!n){
      alert('è«‹è¼¸å…¥å§“å');
      document.getElementById('user-name').focus();
      return;
    }
    if(!a||isNaN(a)||a<0||a>120){
      alert('è«‹è¼¸å…¥æœ‰æ•ˆå¹´é½¡');
      document.getElementById('user-age').focus();
      return;
    }
    if(!g){
      alert('è«‹é¸æ“‡æ€§åˆ¥');
      document.getElementById('user-gender').focus();
      return;
    }
    window.userBasicInfo={
      name:n,
      age:parseInt(a),
      gender:g,
      height:document.getElementById('user-height').value?parseInt(document.getElementById('user-height').value):null,
      weight:document.getElementById('user-weight').value?parseFloat(document.getElementById('user-weight').value):null,
      bp:document.getElementById('user-bp').value.trim()||null,
      glucose:document.getElementById('user-glucose').value?parseFloat(document.getElementById('user-glucose').value):null,
      job:document.getElementById('user-job').value.trim()||null
    };
    document.getElementById('user-info-section').classList.add('hidden');
    document.getElementById('checklist-section').classList.remove('hidden');
    renderSymptomCards();
    initFilterButtons();
    document.getElementById('checklist-section').scrollIntoView({behavior:'smooth'});
    styleButtons();
  });
  document.getElementById('back-to-info').addEventListener('click',function(){
    document.getElementById('checklist-section').classList.add('hidden');
    document.getElementById('user-info-section').classList.remove('hidden');
    if(window.userBasicInfo){
      document.getElementById('user-name').value=window.userBasicInfo.name||'';
      document.getElementById('user-age').value=window.userBasicInfo.age||'';
      document.getElementById('user-gender').value=window.userBasicInfo.gender||'';
      document.getElementById('user-height').value=window.userBasicInfo.height||'';
      document.getElementById('user-weight').value=window.userBasicInfo.weight||'';
      document.getElementById('user-bp').value=window.userBasicInfo.bp||'';
      document.getElementById('user-glucose').value=window.userBasicInfo.glucose||'';
      document.getElementById('user-job').value=window.userBasicInfo.job||'';
    }
    document.getElementById('user-info-section').scrollIntoView({behavior:'smooth'});
  });
  document.getElementById('submit-checklist').addEventListener('click',async function(){
    const btn=this;
    btn.disabled=true;
    btn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i> æäº¤ä¸­...';
    const sc=updateSelectedCount();
    if(sc===0){
      alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç—‡ç‹€');
      btn.disabled=false;
      btn.innerHTML='æäº¤æª¢æŸ¥è¡¨';
      return;
    }
    let iv=true,fic=null;
    document.querySelectorAll('.symptom-checkbox:checked').forEach(cb=>{
      const cd=cb.closest('.symptom-card'),d=cd.querySelector('.duration-select').value,s=cd.querySelector('.severity-select').value;
      if(!d||!s){
        iv=false;
        fic=fic||cd;
        cd.classList.add('border-red-700');
        cd.style.transform='scale(1.03)';
        setTimeout(()=>{
          cd.classList.remove('border-red-700');
          cd.style.transform='';
        },1500);
      }
    });
    if(!iv){
      alert('éƒ¨åˆ†å·²é¸ç—‡ç‹€æœªå¡«å¯«å®Œæ•´è³‡è¨Šï¼Œè«‹æª¢æŸ¥å¾Œå†æäº¤');
      fic&&fic.scrollIntoView({behavior:'smooth',block:'center'});
      btn.disabled=false;
      btn.innerHTML='æäº¤æª¢æŸ¥è¡¨';
      return;
    }
    const sd=await collectSubmitData();
    submitChecklistData(sd,btn);
  });
  document.addEventListener('click',function(e){
    if(e.target.closest('#native-share-btn'))handleShareButtonClick(e);
  });
  styleButtons();
}

async function handleShareButtonClick(e){
  e.stopPropagation();
  e.preventDefault();
  const btn=e.target.closest('#native-share-btn');
  let scEl,mc,st,canvas,dataUrl,fileName;
  try{
    scEl=document.getElementById('summary-content');
    mc=document.querySelector('#success-modal .modal-content')||document.getElementById('success-modal');
    if(!scEl||!mc){
      const rs=document.getElementById('report-summary');
      if(rs)scEl=rs.querySelector('.summary-content')||rs;
      if(!scEl){
        alert('å ±å‘Šå…§å®¹åŠ è¼‰ä¸­ï¼Œè«‹ç¨å€™å†è©¦');
        setTimeout(()=>btn.click(),500);
        return;
      }
    }
    // ä¿å­˜åˆ†äº«æŒ‰é’®åŸå§‹çŠ¶æ€
    const shareButton = scEl.querySelector('#native-share-btn');
    const shareBtnOriginalDisplay = shareButton ? shareButton.style.display : 'flex';
    if(shareButton) shareButton.style.display = 'none';
    st=window.reportData.summaryText;
    btn.disabled=true;
    btn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i> è™•ç†ä¸­...';
    // åŠ è½½html2canvas
    if(!window.html2canvas){
      alert('æ­£åœ¨åŠ è¼‰åˆ†äº«æ‰€éœ€çµ„ä»¶ï¼Œè«‹ç¨å€™...');
      await new Promise((resolve,reject)=>{
        const script=document.createElement('script');
        script.src='https://html2canvas.hertzen.com/dist/html2canvas.min.js';
        script.onload=resolve;
        script.onerror=reject;
        document.head.appendChild(script);
      });
    }
    // è®¾ç½®æˆªå›¾å®¹å™¨æ ·å¼ - æœ€å°å®½åº¦1024pxè§£å†³ç§»åŠ¨ç«¯æŒ¤å‹
    scEl.style.textAlign='center';
    scEl.style.margin='0 auto';
    scEl.style.backgroundColor='#121212';
    scEl.style.padding='1rem';
    scEl.style.minWidth='1024px'; // ä¿®æ”¹ï¼šæå‡è‡³1024px
    scEl.style.maxWidth='100%';
    scEl.style.boxSizing='border-box';
    scEl.style.borderRadius='16px';
    scEl.style.boxShadow='0 4px 20px rgba(0,0,0,0.5)';
    scEl.style.color='#FFFFFF';
    scEl.style.fontWeight='bold'; // ç¡®ä¿æ‰€æœ‰æ–‡å­—ç²—ä½“
    // ç”Ÿæˆæˆªå›¾
    canvas=await html2canvas(scEl,{
      scale:2.0,
      useCORS:true,
      allowTaint:true,
      logging:false,
      backgroundColor:'#121212',
      width:Math.max(scEl.offsetWidth,1024), // ä¿®æ”¹ï¼šç¡®ä¿å®½åº¦ä¸å°äº1024px
      height:scEl.offsetHeight,
      dpi:300,
      windowWidth:Math.max(scEl.offsetWidth,1024), // ä¿®æ”¹ï¼šçª—å£å®½åº¦æœ€å°1024px
      windowHeight:scEl.offsetHeight
    });
    // æ¢å¤åˆ†äº«æŒ‰é’®æ˜¾ç¤º
    if(shareButton) shareButton.style.display = shareBtnOriginalDisplay;
    // å¤„ç†æˆªå›¾æ•°æ®
    dataUrl=canvas.toDataURL('image/png',0.9);
    fileName=`ğŸ§¬ å½¥å½¬è‡ªæª¢è¡¨ç³»çµ±_${new Date().toLocaleDateString()}.png`;
    const imgBlob=await (await fetch(dataUrl)).blob();
    let file;
    if(imgBlob.size>5*1024*1024){
      alert('åœ–ç‰‡é«”ç©éå¤§ï¼Œè¼•å¾®å£“ç¸®ä¿æŒæ¸…æ™°...');
      dataUrl=canvas.toDataURL('image/png',0.8);
      const compressedBlob=await (await fetch(dataUrl)).blob();
      file=new File([compressedBlob],fileName,{type:'image/png'});
    }else file=new File([imgBlob],fileName,{type:'image/png'});
    // åˆ†äº«é€»è¾‘
    if(navigator.share&&typeof navigator.share==='function'){
      try{
        const shareData={
          title:'ğŸ§¬ å½¥å½¬è‡ªæª¢è¡¨ç³»çµ±',
          files:[file],
          text:st
        };
        const canShare=navigator.canShare?await navigator.canShare(shareData):true;
        if(canShare){
          await navigator.share(shareData);
          alert('åˆ†äº«æˆåŠŸï¼\nå ±å‘Šå·²ç™¼é€åˆ°LINEç¾¤çµ„/å¥½å‹');
        }
      }catch(err){
        console.error('LINEåˆ†äº«å¤±æ•—ï¼š',err);
        if(err.name!=='AbortError')alert(`åˆ†äº«å¤±æ•—ï¼š${err.message||'æœªçŸ¥éŒ¯èª¤'}`);
      }
    }else{
      try{
        await navigator.clipboard.writeText(st);
        alert('æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼Œè«‹æ‰‹å‹•æˆªåœ–åˆ†äº«');
      }catch(cbErr){
        alert('è«‹æ‰‹å‹•æˆªåœ–ä¸¦è¤‡è£½æ–‡å­—åˆ†äº«');
      }
    }
  }catch(err){
    console.error('åˆ†äº«ç¸½é«”éŒ¯èª¤ï¼š',err);
    alert('åˆ†äº«åŠŸèƒ½ç•°å¸¸ï¼Œè«‹æ‰‹å‹•æˆªåœ–åˆ†äº«');
  }finally{
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    btn.disabled=false;
    btn.innerHTML='<i class="fa fa-share-alt mr-1"></i> åˆ†äº«åˆ°LINE';
    // åˆ›å»º/æ˜¾ç¤ºå…³é—­æŒ‰é’®
    let closeBtn=document.getElementById('close-page-btn');
    if(!closeBtn){
      closeBtn=document.createElement('button');
      closeBtn.id='close-page-btn';
      closeBtn.className='w-full sm:w-auto px-6 py-2.5 bg-gray-800 text-gray-200 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-0.5 active:translate-y-0 mt-2';
      closeBtn.innerHTML='<i class="fa fa-times"></i> é—œé–‰ç¶²é ';
      closeBtn.onclick=async()=>{
        try {
          if(window.liff) {
            if(!liff.isLoggedIn()) await liff.login();
            liff.closeWindow();
          } else {
            window.close();
          }
        } catch (error) {
          console.error('é—œé–‰çª—å£å¤±æ•—:', error);
          window.close();
        }
      };
      // ç¡®ä¿æŒ‰é’®å®¹å™¨å­˜åœ¨ä¸”æŒ‰é’®ä¸ä¸¢å¤±
      const btnContainer = btn.parentNode;
      if(!btnContainer.classList.contains('share-btn-container')){
        const newContainer = document.createElement('div');
        newContainer.className = 'share-btn-container flex flex-col w-full gap-2';
        btnContainer.appendChild(newContainer);
        newContainer.appendChild(btn);
        newContainer.appendChild(closeBtn);
      }else{
        btnContainer.appendChild(closeBtn);
      }
    }else{
      closeBtn.style.display = 'flex';
    }
  }
}

async function collectSubmitData(){
  const liffProfile=await liff.getProfile().catch(err=>{
    console.error("ç²å–LINEç”¨æˆ¶ä¿¡æ¯å¤±æ•—ï¼š",err);
    return {displayName:'LINEç”¨æˆ¶'};
  });
  const selectedSymptoms=Array.from(document.querySelectorAll('.symptom-checkbox:checked')).map(cb=>{
    const seq=cb.dataset.seq,cd=cb.closest('.symptom-card');
    return{
      seq:parseInt(seq),
      symptom:cd.querySelector('label').textContent.replace(/^\[\d+\]/,'').trim(),
      durationText:cd.querySelector('.duration-select option:checked').textContent,
      severityText:cd.querySelector('.severity-select option:checked').textContent
    };
  });
  return{
    action:'submitChecklist',
    userId:liff.getDecodedIDToken()?.sub||'',
    displayName:liffProfile.displayName||'LINEç”¨æˆ¶',
    submitTime:new Date().toISOString(),
    userName:document.getElementById('user-name').value.trim(),
    userAge:document.getElementById('user-age').value.trim(),
    userGender:document.getElementById('user-gender').value,
    userHeight:document.getElementById('user-height').value.trim()||'',
    userWeight:document.getElementById('user-weight').value.trim()||'',
    userBp:document.getElementById('user-bp').value.trim()||'',
    userGlucose:document.getElementById('user-glucose').value.trim()||'',
    userJob:document.getElementById('user-job').value.trim()||'',
    selectedSymptoms:JSON.stringify(selectedSymptoms)
  };
}

function submitChecklistData(data,btn){
  console.log("æäº¤æ•¸æ“šï¼ˆå«çœŸå¯¦LINEåç¨±ï¼‰ï¼š",data);
  setStatus('æäº¤ä¸­...');
  document.getElementById('status').classList.remove('hidden');
  $.ajax({
    url:GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    jsonpCallback:'submitCallback',
    timeout:JSONP_TIMEOUT,
    data:data,
    success:function(resp){
      document.getElementById('status').classList.add('hidden');
      alert('æäº¤æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆå¥åº·å ±å‘Š...');
      const rd=organizeReportData({...data,userBasicInfo:window.userBasicInfo,selectedSymptoms:JSON.parse(data.selectedSymptoms)});
      window.reportData=rd;
      renderReportSummary(rd);
      document.getElementById('success-modal').classList.remove('hidden');
      setTimeout(()=>{
        document.getElementById('report-summary')&&(document.getElementById('report-summary').style.maxHeight='80vh');
      },100);
      btn.disabled=false;
      btn.innerHTML='æäº¤æª¢æŸ¥è¡¨';
    },
    error:function(xhr,status,err){
      console.error("æäº¤å¤±æ•—ï¼š",status,err);
      document.getElementById('status').classList.add('hidden');
      const errMsg=status==='timeout'?'è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥':
      status==='parsererror'?'æ•¸æ“šè§£æéŒ¯èª¤ï¼Œä¼ºæœå™¨è¿”å›ç„¡æ•ˆæ•¸æ“š':'èˆ‡ä¼ºæœå™¨é€šè¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      showError(`${errMsg}ï¼ˆéŒ¯èª¤ï¼š${err.message || status}ï¼‰`);
      btn.disabled=false;
      btn.innerHTML='æäº¤æª¢æŸ¥è¡¨';
    }
  });
}

function renderReportSummary(reportData){
  const {formattedUserInfo,factorSymptoms,summaryText,totalSymptomCount,selectedTotal,topFactors}=reportData;
  let sc=document.getElementById('summary-content');
  if(!sc){
    sc=document.createElement('div');
    sc.id='summary-content';
    const rs=document.getElementById('report-summary')||document.createElement('div');
    rs.id='report-summary';
    rs.appendChild(sc);
    document.querySelector('#success-modal .modal-content')?.appendChild(rs)||document.body.appendChild(rs);
  }
  sc.dataset.summary=summaryText;
  const ts=Object.values(factorSymptoms).reduce((s,f)=>s+f.length,0);
  const rs=document.getElementById('report-summary');
  rs.style.maxHeight='80vh';
  rs.style.overflowY='auto';
  rs.style.padding='1rem';
  rs.style.boxSizing='border-box';
  rs.style.backgroundColor='#121212';
  rs.style.borderRadius='16px';
  rs.style.boxShadow='0 4px 20px rgba(0,0,0,0.5)';
  rs.style.margin='0 auto';
  rs.style.width='100%';
  rs.style.minWidth='1024px'; // ä¿®æ”¹ï¼šæˆªå›¾å®¹å™¨æœ€å°å®½åº¦1024px
  rs.style.maxWidth='100%';
  sc.style.width='100%';
  sc.style.backgroundColor='#121212';
  sc.style.padding='1rem';
  sc.style.boxSizing='border-box';
  sc.style.lineHeight='1.4';
  sc.style.fontSize='0.9rem';
  sc.style.textAlign='center';
  sc.style.color='#FFFFFF';
  sc.style.fontWeight='bold'; // å…¨å±€ç²—ä½“
  let html=`
<div class="text-center mb-4 font-bold">
  <h3 class="text-lg md:text-xl font-bold text-white mb-2 font-bold">ğŸ§¬ å½¥å½¬è‡ªæª¢è¡¨ç³»çµ±</h3>
  <div class="text-xs text-gray-400 font-bold font-bold">${formattedUserInfo.æäº¤æ™‚é–“}</div>
</div>
<div class="bg-gray-800 rounded-lg p-3 mb-4 mx-auto max-w-full border border-gray-700 font-bold">
  <div class="text-base font-bold text-white mb-2 flex items-center justify-center font-bold">
    <i class="fa fa-user-circle text-primary mr-2 text-sm font-bold"></i>åŸºæœ¬è³‡æ–™
  </div>
  <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-sm text-gray-200 font-bold font-bold">`;
  const infoEntries=Object.entries(formattedUserInfo);
  infoEntries.forEach(([k,v])=>{
    if(k!=='æäº¤æ™‚é–“'){
      const label=k==='è¡€ç³–'?'è¡€ç³–':k;
      html+=`<div class="flex justify-between font-bold">
        <span class="text-gray-400 font-bold font-bold">${label}ï¼š</span>
        <span class="text-white font-bold font-bold">${v}</span>
      </div>`;
    }
  });
  html+=`</div></div>
<div class="mb-4 font-bold">
  <div class="text-base font-bold text-white flex items-center justify-center mb-2 font-bold">
    <i class="fa fa-chart-pie text-primary mr-2 text-sm font-bold"></i>çµ±è¨ˆè³‡è¨Š
  </div>
  <div class="bg-green-900/30 text-green-400 px-3 py-1.5 rounded-full text-sm font-bold inline-flex items-center justify-center mx-auto mb-2 font-bold">
    ç¸½ç—‡ç‹€æ•¸ï¼š${selectedTotal} é … (å…±${totalSymptomCount}ç¨®ç—‡ç‹€)
  </div>`;
  if(topFactors.length > 0){
    if(topFactors.length === 1){
      html+=`<div class="bg-blue-900/30 text-blue-400 px-3 py-1.5 rounded-full text-sm font-bold inline-flex items-center justify-center mx-auto font-bold">
        èª¿æ•´æ–¹å‘ï¼š${topFactors[0].name} (${topFactors[0].count}é …)
      </div>`;
    } else {
      html+=`<div class="bg-blue-900/30 text-blue-400 px-3 py-1.5 rounded-full text-sm font-bold inline-flex items-center justify-center mx-auto font-bold">
        èª¿æ•´æ–¹å‘ï¼š${topFactors[0].name} (${topFactors[0].count}é …)ã€${topFactors[1].name} (${topFactors[1].count}é …)
      </div>`;
    }
  }
  html+=`</div>
<div class="text-base font-bold text-white mb-3 flex items-center justify-center font-bold">
  <i class="fa fa-heartbeat text-primary mr-2 text-sm font-bold"></i>ä¸ƒå¤§å¥åº·è¦ç´ è©•ä¼°
</div>`;
  Object.entries(factorSymptoms).forEach(([fk,f])=>{
    const fn=factorStyles[fk].label;
    html+=`<div class="bg-gray-800 border border-gray-700 rounded-lg p-3 mb-3 shadow-sm hover:shadow-md transition-shadow mx-auto max-w-full font-bold">
  <div class="font-bold text-sm text-white mb-2 flex items-center justify-center font-bold">
    <span class="inline-block w-2.5 h-2.5 rounded-full ${factorStyles[fk].className.split(' ')[0]} mr-1.5 font-bold"></span>
    ã€${fn}ã€‘ï¼ˆ${f.length}é …ï¼‰
  </div>
  <!-- ä¿®æ”¹ï¼šéŸ¿æ‡‰å¼å››åˆ—å¸ƒå±€ -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 font-bold">`; // ä¿®æ”¹ï¼šmd:grid-cols-4 å®ç°ä¸€è¡Œå››åˆ—
    f.forEach((i,idx)=>{
      let severityClass = '';
      if(i.severity.includes('ä¸­åº¦')) severityClass = 'bg-yellow-900/30 text-yellow-400 font-bold';
      else if(i.severity.includes('é‡åº¦')) severityClass = 'bg-red-900/30 text-red-400 font-bold';
      else severityClass = 'bg-gray-700 text-gray-300 font-bold';
      // ç¡®è®¤ï¼šç—‡ç‹€åç¨±11pxï¼Œæ™‚é–“/åš´é‡ç¨‹åº¦9pxï¼Œå…¨ç²—é«”
      html+=`<div class="p-2 bg-gray-700 rounded-lg border border-gray-600 font-bold">
        <div class="font-bold text-[11px] text-white font-bold">${idx+1}. ${i.name}</div>
        <div class="flex justify-between mt-1 text-[9px] font-bold font-bold">
          <div class="text-gray-400 font-bold font-bold">â±ï¸ ${i.duration}</div>
          <div class="${severityClass} px-2 py-0.5 rounded text-[9px] font-bold font-bold">âš ï¸ ${i.severity}</div>
        </div>
      </div>`;
    });
    html+=`</div></div>`;
  });
  html+=`<div class="mt-4 bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm text-gray-300 font-bold mx-auto max-w-full font-bold">
ğŸ’¡ å»ºè­°ï¼šæ ¹æ“šè‡ªæª¢çµæœé—œæ³¨å°æ‡‰å¥åº·å•é¡Œï¼Œå¿…è¦æ™‚è«®è©¢å°ˆæ¥­é†«å¸«
</div>
<div class="mt-6 mb-3 flex justify-center px-3 font-bold">
  <button id="native-share-btn" class="w-full sm:w-auto px-5 py-2 bg-[#00C300] text-white rounded-lg font-bold flex items-center justify-center gap-1.5 shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-0.5 active:translate-y-0 font-bold">
    <i class="fa fa-share-alt font-bold"></i> åˆ†äº«åˆ°LINE
  </button>
</div>`;
  sc.innerHTML=html;
  setTimeout(()=>{
    rs.style.height=sc.offsetHeight+60+'px';
    rs.style.display='none';
    rs.offsetHeight;
    rs.style.display='block';
  },150);
}

function resetChecklist(){
  document.querySelectorAll('.symptom-checkbox').forEach(cb=>{
    cb.checked&&(cb.checked=false,cb.dispatchEvent(new Event('change')));
  });
  document.getElementById('filter-all').click();
  const fsBtn=document.getElementById('filter-selected');
  fsBtn.classList.contains('bg-red-900/50')&&fsBtn.click();
  window.userBasicInfo=null;
  window.reportData=null;
  document.getElementById('user-name').value='';
  document.getElementById('user-age').value='';
  document.getElementById('user-gender').value='';
  document.getElementById('user-height').value='';
  document.getElementById('user-weight').value='';
  document.getElementById('user-bp').value='';
  document.getElementById('user-glucose').value='';
  document.getElementById('user-job').value='';
}

function forceShowUserInfo(){
  try{
    const uis=document.getElementById('user-info-section');
    if(!uis){
      alert("é é¢åŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°");
      return false;
    }
    uis.classList.remove('hidden');
    initControlButtons();
    return true;
  }catch(e){
    console.error("é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šå‡ºéŒ¯ï¼š",e);
    alert("é é¢åŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°");
    return false;
  }
}

document.addEventListener('DOMContentLoaded',function(){
  console.log("é é¢åŠ è¼‰å®Œæˆï¼Œåˆå§‹åŒ–ç³»çµ±");
  setStatus('æ­£åœ¨åˆå§‹åŒ–...');
  if(!window.liff){
    showError('LINE LIFFåˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–é‡æ–°æ‰“é–‹é é¢');
    return;
  }
  liff.init({ liffId: LIFF_ID, enableAnonymousLogin: false }, { disableRedirect: true })
  .then(()=>{
    console.log("LIFFåˆå§‹åŒ–æˆåŠŸ");
    liff.isLoggedIn()?getProfileAndVerify():liff.login();
  })
  .catch(err=>{
    console.error("LIFFåˆå§‹åŒ–å¤±æ•—ï¼š",err);
    if(err.message.includes('expired')||err.message.includes('token')||err.message.includes('auth')){
      setStatus('ä»¤ç‰Œç„¡æ•ˆï¼Œé‡æ–°ç™»éŒ„...');
      setTimeout(()=>liff.login(),1000);
    }else showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š'+err.message);
  });
});

function getProfileAndVerify(){
  setStatus('æ­£åœ¨ç²å–ç”¨æˆ¶è³‡è¨Š...');
  liff.getProfile()
  .then(profile=>{
    console.log("ç²å–LINEè³‡æ–™æˆåŠŸï¼š",profile);
    callGasBackend(profile.userId,profile.displayName||'LINEç”¨æˆ¶');
  })
  .catch(err=>{
    console.error("ç²å–LINEè³‡æ–™å¤±æ•—ï¼š",err);
    const tokenErrs=['expired','token','auth','invalid','session'];
    const isTokenErr=tokenErrs.some(k=>err.message.toLowerCase().includes(k));
    if(isTokenErr){
      setStatus('ä»¤ç‰ŒéæœŸï¼Œé‡æ–°ç™»éŒ„...');
      liff.isLoggedIn()?liff.logout().then(()=>setTimeout(()=>liff.login(),1000)).catch(()=>liff.login()):setTimeout(()=>liff.login(),1000);
    }else showError('å–å¾—ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼š'+err.message);
  });
}

function callGasBackend(userId,displayName){
  setStatus('æ­£åœ¨é©—è­‰ç”¨æˆ¶æ¬Šé™...');
  $.ajax({
    url:GAS_URL,
    dataType:'jsonp',
    jsonp:'callback',
    jsonpCallback:'verifyCallback',
    timeout:JSONP_TIMEOUT,
    data:{userId:userId,displayName:displayName,action:'verifyUser',needExpiryDate:true},
    success:function(resp){
      console.log("å¾Œç«¯è¿”å›ï¼š",resp);
      resp.status==="error"?showError(resp.message):renderResult(resp);
    },
    error:function(xhr,status,err){
      console.error("AJAXéŒ¯èª¤ï¼š",status,err);
      const errMsg=status==='timeout'?'è«‹æ±‚è¶…æ™‚ï¼Œæª¢æŸ¥ç¶²çµ¡':
      status==='parsererror'?'æ•¸æ“šè§£æéŒ¯èª¤':'èˆ‡ä¼ºæœå™¨é€šè¨Šå¤±æ•—';
      showError(errMsg);
    }
  });
}

function renderResult(resp){
  document.getElementById('status').classList.add('hidden');
  document.getElementById('error-message').classList.add('hidden');
  const card=document.getElementById('result-card'),main=document.getElementById('result-main'),details=document.getElementById('result-details');
  const isPro=resp.isAdmin===true,un=resp.displayName||'ç”¨æˆ¶',ed=resp.expiryDate||resp.endDate||resp.expireDate||'';
  if(isPro){
    const{displayDate,remainingDays}=calculateRemainingDaysByDate(ed);
    main.innerHTML=`<span class="text-primary font-bold font-bold"><i class="fa fa-check-circle mr-1.5 font-bold"></i>å°ˆæ¥­ç”¨æˆ¶é©—è­‰é€šé</span>`;
    details.innerHTML=`
<div class="font-bold font-bold"><i class="fa fa-user-circle text-primary mr-1 font-bold"></i>ç”¨æˆ¶åç¨±ï¼š<span class="font-bold font-bold">${un}</span></div>
<div class="font-bold font-bold"><i class="fa fa-calendar-check-o text-primary mr-1 font-bold"></i>ä½¿ç”¨æœŸé™ï¼š<span class="font-bold font-bold">${displayDate}</span></div>
<div class="font-bold font-bold"><i class="fa fa-clock-o text-primary mr-1 font-bold"></i>å‰©é¤˜å¤©æ•¸ï¼š${remainingDays}</div>
`;
  }else{
    const uc=resp.usageCount||0,rt=Math.max(0,3-uc);
    if(rt<=0){
      main.innerHTML=`<span class="text-orange-600 font-bold font-bold"><i class="fa fa-exclamation-circle mr-1.5 font-bold"></i>æ™®é€šç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œ</span>`;
      details.innerHTML=`
<div class="font-bold font-bold"><i class="fa fa-user-circle text-orange-600 mr-1 font-bold"></i>ç”¨æˆ¶åç¨±ï¼š<span class="font-bold font-bold">${un}</span></div>
<div class="font-bold font-bold"><i class="fa fa-calendar-o text-orange-600 mr-1 font-bold"></i>ä½¿ç”¨æœŸé™ï¼š<span class="font-bold font-bold">-</span></div>
<div class="font-bold font-bold"><i class="fa fa-refresh text-orange-600 mr-1 font-bold"></i>å‰©é¤˜æ¬¡æ•¸ï¼š<span class="text-red-500 font-bold font-bold">${rt} æ¬¡</span></div>
<div class="font-bold font-bold"><i class="fa fa-info-circle text-orange-600 mr-1 font-bold"></i>æç¤ºï¼šè«‹è¯ç¹«ç®¡ç†å“¡å‡ç´š</div>
`;
      card.classList.remove('hidden');
      return;
    }else{
      main.innerHTML=`<span class="text-textPrimary font-bold font-bold"><i class="fa fa-user mr-1.5 font-bold"></i>æ™®é€šç”¨æˆ¶é©—è­‰é€šé</span>`;
      details.innerHTML=`
<div class="font-bold font-bold"><i class="fa fa-user-circle text-textPrimary mr-1 font-bold"></i>ç”¨æˆ¶åç¨±ï¼š<span class="font-bold font-bold">${un}</span></div>
<div class="font-bold font-bold"><i class="fa fa-calendar-o text-textPrimary mr-1 font-bold"></i>ä½¿ç”¨æœŸé™ï¼š<span class="font-bold font-bold">-</span></div>
<div class="font-bold font-bold"><i class="fa fa-refresh text-textPrimary mr-1 font-bold"></i>å‰©é¤˜æ¬¡æ•¸ï¼š<span class="font-bold text-primary font-bold">${rt} æ¬¡</span></div>
`;
    }
  }
  card.classList.remove('hidden');
  setTimeout(()=>forceShowUserInfo(),300);
}

window.submitCallback=resp=>{console.log("submitCallback:",resp);return resp;};
window.verifyCallback=resp=>{console.log("verifyCallback:",resp);return resp;};
</script>

</body>
</html>
